var Engine=function(){function O(){this.default_level=5}function P(a,k,c,g,e,d,b,f){var p,u,h,l,r,w=M,m=a.board,x=m[e],z=m[d];m[d]=x;m[e]=0;var n=x&14,s=x&1,t=x,y=r=p=0;n==B?900<(60-d)*(60-d)?(w|=s,t=m[d]=w):(e^d)&1&&0==z?(l=d-10+20*s,r=m[l],m[l]=0):400==(e-d)*(e-d)&&(y=e+d>>1):n==H&&4==(e-d)*(e-d)&&(p=e-4+7*(e<d),u=e+d>>1,h=s+N,m[p]=0,m[u]=h);if(w=a.castles){var m=0,n=2*s,v=70*s,q=e-v,v=d+v;25==q?m|=3<<n:21==q?m|=1<<n:28==q&&(m|=2<<n);91==v?m|=4>>n:98==v&&(m|=8>>n);a.castles&=~m}for(var m=a.pieces.concat(),
C=m[s],n=a.pieces[s]=[],q=0;q<C.length;q++){var v=C[q],G=v[1];G!=e&&G!=p&&n.push(v)}n.push([t,d]);h&&n.push([h,u]);if(z||r)for(t=m[1-s],n=a.pieces[1-s]=[],s=r?l:d,q=0;q<t.length;q++)v=t[q],v[1]!=s&&n.push(v);s=1-c;y=Q(a,c,y,-g);t=y.length;if(k){for(g=0;g<t;g++){v=y[g];n=v[0];q=v[1];v=v[2];if(n>R){b=S;break}n=-P(a,k-1,s,n,q,v,-f,-b);n>b&&(b=n);if(b>=f)break}b<-aa&&!ba(a,c)&&(b=a.stalemate_scores[c]);b<-R&&(b+=ga)}else for(;f>b&&-1!=--t;)y[t][0]>b&&(b=y[t][0]);k=a.board;l&&(k[l]=r);k[e]=x;k[d]=z;p&&
(k[p]=h,k[u]=0);a.pieces=m;a.castles=w;return b}function Q(a,k,c,g){var e=a.board,d,b,f,p,u,h=1-k,l=10-20*k,r=[],w=[],m,x=a.pieces[k],z=a.castles>>2*k&3,n=a.values[h],s=a.weights;for(u=x.length-1;0<=u;u--){a=x[u][1];f=e[a];var t=s[f];m=g-t[a];f&=14;if(2<f){var y=E[f];if(f&2){for(p=0;8>p;p++)d=a+y[p],(b=e[d])?(b&17)==h&&w.push([m+n[b]+t[d]+s[b][d],a,d]):r.push([m+n[b]+t[d],a,d]);f==H&&z&&(z&1&&0==e[a-1]+e[a-2]+e[a-3]&&T(e,a-2,h,l,-1)&&r.push([m+12,a,a-2]),z&2&&0==e[a+1]+e[a+2]&&T(e,a,h,l,1)&&r.push([m+
13,a,a+2]))}else for(f=y.length,p=0;p<f;){var v=y[p++];d=a;do d+=v,(b=e[d])?(b&17)==h&&w.push([m+n[b]+t[d]+s[b][d],a,d]):r.push([m+n[b]+t[d],a,d]);while(!b)}}else d=a+l,e[d]||(r.push([m+t[d],a,d]),b=d+l,3200>a*(120-a)&&!e[b]&&r.push([m+t[b],a,b])),(b=e[--d])&&(b&17)==h&&w.push([m+n[b]+t[d]+s[b][d],a,d]),d+=2,(b=e[d])&&(b&17)==h&&w.push([m+n[b]+t[d]+s[b][d],a,d])}c&&(k|=B,a=c-l-1,e[a]==k&&(x=n[B]+s[B|h][c-l],w.push([g-t[a]+t[c]+x,a,c])),a+=2,e[a]==k&&(x=n[B]+s[B|h][c-l],w.push([g-t[a]+t[c]+x,a,c])));
return w.concat(r)}function T(a,k,c,g,e){var d,b,f=c+U,p=V|c,u=N|c,h=2|c;for(b=k;b<k+3;b++){c=b;do c+=g,d=a[c];while(!d);if((d&23)==u)return 0;c=b;var l=g-1;do c+=l,d=a[c];while(!d);if((d&27)==p)return 0;c=b;l+=2;do c+=l,d=a[c];while(!d);if((d&27)==p||a[b+g-2]==f||a[b+g+2]==f)return 0}for(b=k+g-1;b<k+g+4;b++)if(d=a[b]&23,d==h||a[b+g]==f)return 0;c=0>e?k+2:k;do c-=e,d=a[c];while(!d);return(d&23)==u?0:1}function ba(a,k){var c=a.board,g=a.pieces[k],e,d=g.length;do e=g[--d];while(e[0]!=(H|k));g=e[1];
e=1-k;d=10-20*k;if(c[g+d-1]==(B|e)||c[g+d+1]==(B|e))return!0;for(var b=E[U],f=E[H],p=U|e,u=H|e,d=0;8>d;d++)if(c[g+b[d]]==p||c[g+f[d]]==u)return!0;b=E[V];f=E[N];p=V|e;e|=N;for(d=0;4>d;d++){var u=b[d],h=g,l;do h+=u,l=c[h];while(!l);if((l&27)==p)return!0;u=f[d];h=g;do h+=u,l=c[h];while(!l);if((l&23)==e)return!0}return!1}function ha(a){for(var k,c,g,e,d=[Q(a,0,0,0),Q(a,1,0,0)],b=a.board,f=0;2>f;f++){var p=a.values[f],u=a.pieces[f],h=d[f],l=d[1-f],r=[];for(k=0;k<u.length;k++)c=u[k],r[c[1]]={score:0,piece:c[0],
pos:c[1],threatened:0};for(k=h.length-1;0<=k;k--)e=h[k],c=e[0],g=e[1],e=e[2],b[e]||(g=r[g],g.score=Math.max(g.score,c));for(k=l.length-1;0<=k;k--)e=l[k],g=r[e[2]],void 0!==g&&(h=0.01*(1+g.piece>3+b[e[1]]<4),g.threatened<h&&(g.threatened=h));l=[];for(k=20;100>k;k++)c=r[k],void 0!==c&&(c.score+=c.threatened*p[c.piece],l.push(c));l.sort(function(a,b){return a.score-b.score});for(k=0;k<l.length;k++)c=l[k],u[k]=[c.piece,c.pos]}}function ia(a,k,c,g){var e,d,b,f,p,u=a.pieces=[[],[]],h=a.moveno>>1,l=a.board,
r=50<h?0:parseInt(6*Math.exp(-0.07*h)),w=12>h,m=5>h;b=[0,0];var x=[0,0],z=[0,0];for(e=20;100>e;e++){p=l[e];var n=p&14;f=p&1;n&&(u[f].push([p,e]),n==H?b[f]=e:(x[f]+=K[n],z[f]=Math.max(z[f],K[n])))}u=90<a.draw_timeout||2<=a.current_repetitions;a.values=[[],[]];var s=K[M],t=x[0]+x[1]+2*s;f=2*(x[1]+s)/t;var y=2*(x[0]+s)/t,x=[f,y],n=4*M/t;a.stalemate_scores=[parseInt(0.5+2*(f-1)*s),parseInt(0.5+2*(y-1)*s)];for(e=0;e<K.length;e++){var v=K[e];v<R?(a.values[0][e]=parseInt(v*f+0.5),a.values[1][e]=parseInt(v*
y+0.5)):(a.values[0][e]=v,a.values[1][e]=v)}a.best_pieces=[parseInt(z[0]*f+0.5),parseInt(z[1]*y+0.5)];z=[b[0]%10,b[1]%10];y=[parseInt(b[0]/10),parseInt(b[1]/10)];v=[[],[]];for(f=3;9>f;f++)for(b=1;9>b;b++)e=10*f+b,p=l[e],(p&14)==B&&(0==(p&1)?v[0][b]=f:void 0===v[1][b]&&(v[1][b]=f));l=20<=h||t<5*s;p=a.weights;for(f=2;10>f;f++)for(b=1;9>b;b++){e=10*f+b;for(var s=W[e]*r,t=X[e],q=0;2>q;q++){d=Math.abs(z[1-q]-b);var C=Math.abs(y[1-q]-f),G=Math.abs(z[q]-b),E=Math.max(Math.sqrt(d*d+C*C),1)+1,D=x[q],J=D*D*
D,I=f==2+7*q,O=f==3+5*q,P=f==5+q,T=f==9-7*q,L=-5*(m&&I),Y=parseInt(0.3*s)+2*t+L,F=parseInt(0.3*s),L=parseInt(0.6*s)+t+L;I&&(F+=(4==b||5==b)*(r+!l),F+=(1==b||8==b)*(10<h&&20>h)*-3,F+=(2==b||7==b)*(10<h&&20>h)*-1);var Z=parseInt(0.5*t+s*(0.5-m)),I=2*(w&&I)*r,A=Math.max(2*n,1)*$[q?119-e:e];m&&(4<=f&&7>=f&&(A+=parseInt(0.1*(1+3*(5==f||6==f)+ca(a,4))*s)),4==b||5==b)&&(A-=3*O,A+=3*P);T&&(A+=a.values[q][M]-a.values[q][B]);A+=4*(3==f&&2==y[q]&&2>Math.abs(G)&&5!=z[q]&&4!=b&&5!=b);G=v[1-q];if(void 0==G[b]||
0==q&&G[b]<f||1==q&&G[b]>f)A+=2;l&&(Y+=2*parseInt(8*D/E),F+=2*((2>d)+(2>C)),L+=3*(2>Math.abs(d-C)),Z+=2*parseInt(8/E)+(0==d*C)+(0==d-C),I+=parseInt(150*n/(J*E)+8*n*W[e]*J));p[B+q][e]=A;p[U+q][e]=Y;p[N+q][e]=F;p[V+q][e]=L;p[M+q][e]=Z;p[H+q][e]=I;if(u&&1>D)for(C=3/J,d=2+q;14>d;d+=2)p[d][e]+=ca(a,C)}}a.prepared=!0;ha(a);2==arguments.length&&(c=a.to_play,g=a.enpassant);e=Q(a,c,g,0);h=da;m=w=0;if(0>=k){for(r=0;r<e.length;r++)n=e[r],e[r][0]>h&&(h=n[0],w=n[1],m=n[2]);return[w,m,h]}for(r=0;r<e.length;r++){n=
e[r];x=n[0];u=n[1];n=n[2];if(x>R){h=S;w=u;m=n;break}x=-a.treeclimber(a,k-1,1-c,x,u,n,da,-h);x>h&&(h=x,w=u,m=n)}h<-aa&&!ba(a,c)&&(h=a.stalemate_scores[c]);return[w,m,h]}function D(){if(ea)return new Int32Array(120);if(0==J.length)for(var a=0;120>a;a++)J[a]=0;return J.slice()}function fa(a){a=a.rng;var k=a[1],c=a[2],g=a[0]-(k<<27|k>>>5);a[0]=k^(c<<17|c>>>15);a[1]=c+a[3]&4294967295;a[2]=a[3]+g&4294967295;a[3]=g+a[0]&4294967295;return a[3]&2147483647}function ca(a,k){var c=k;c--;var c=c|c>>>1,c=c|c>>>
2,c=c|c>>>4,c=c|c>>>8,c=c|c>>>16,g;do g=fa(a)&c;while(g>=k);return g}void 0===Date.now&&(Date.now=function(){return(new Date).getTime()});var B=2,N=4,U=6,V=8,M=12,H=10,E=[[],[],[],[],[1,10,-1,-10],[],[21,19,12,8,-21,-19,-12,-8],[],[11,9,-11,-9],[],[1,10,11,9,-1,-10,-11,-9],[],[1,10,11,9,-1,-10,-11,-9],[]],K=[0,0,20,20,100,100,60,60,61,61,8E3,8E3,180,180,0],S=K[10],R=S>>1,ga=300,aa=S-250,da=-9999,W,$,X,ea=void 0!==this.Int32Array,ja={P:2,p:3,R:4,r:5,N:6,n:7,B:8,b:9,K:10,k:11,Q:12,q:13},J=[];O.prototype.find_best_move=
function(a,k){"undefined"===typeof k&&(k=this.default_level);var c=D();W=D();$=D();X=D();for(var g=0;120>g;g++){var e=parseInt(g/10),d=g%10,b=Math.abs(d-4.5),f=Math.abs(e-5.5);W[g]=parseInt(6-Math.pow(1.5*(b*b+f*f),0.6));X[g]=parseInt((2>b)+1.5*(2>f)+(3>b)+(3>f))-2;$[g]=parseInt("000012347000".charAt(e));if(9<e||2>e||1>d||8<d)c[g]=16}e=[];for(g=0;14>g;g++)e[g]=D();c={board:c,weights:e,history:[],treeclimber:P};g=Date.now();g&=4294967295;c.rng=ea?new Uint32Array(4):[];c.rng[0]=4058668781;c.rng[1]=
g;c.rng[2]=g;c.rng[3]=g;for(g=0;20>g;g++)fa(c);var g=c.board,b=a.split(" "),p=b[0],u=b[1],e=b[2],f=b[3],d=b[4],b=b[5];void 0===d&&(d=0);for(var h=90,l=1,r=0;r<p.length;r++){var w=p.charAt(r);if("/"==w){if(l=1,h-=10,20>h)break}else{var m=ja[w];if(m&&9>l)g[h+l]=m,l++;else for(w=Math.min(l+parseInt(w),9);l<w;l++)g[h+l]=0}}c.to_play="b"==u.toLowerCase()?1:0;for(h=c.castles=0;h<e.length;h++)l={k:8,q:4,K:2,Q:1}[e.charAt(h)],c.castles|=l||0;"-"!=f?(h=parseInt(f.charAt(0),19)-9,f=parseInt(f.charAt(1))+1,
f=2<=f&&10>f&&1<=h&&9>h?10*f+h:void 0):f=0;c.enpassant=f;c.draw_timeout=parseInt(d);if(void 0===b){b=d=0;for(h=20;100>h;h+=10)for(l=1;9>l;l++)f=g[h+l]&15,d+=!!f,8>l&&(p=g[h+l+1],b+=!p!=!f),90>h&&(p=g[h+l+10],b+=!p!=!f);b=Math.max(1,parseInt(1.3*(32-d)+1.5*(4-e.length)+(b-16)/5))}c.moveno=2*(parseInt(b)-1)+c.to_play;c.history=[];c.beginning=a;c.prepared=!1;c.position_counts={};return ia(c,k)};return O}();
